error_log stderr notice;

worker_processes auto;
events {
  multi_accept on;
  use epoll;
  worker_connections 1024;
}

stream {
        upstream kube_apiserver {
            {{ $servers := split (getenv "CP_HOSTS") "," }}{{range $servers}}
            server {{.}}:6443;
            {{end}}
            check interval=3000 rise=2 fall=5 timeout=1000 type=http;
            check_keepalive_requests 100;
            check_http_send "HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n";
            check_http_expect_alive http_2xx http_3xx http_4xx;

        }

        server {
            listen        6443;
            proxy_pass    kube_apiserver;
            proxy_timeout 30;
            proxy_connect_timeout 2s;

        }

}
